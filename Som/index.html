<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Participació Ciutadana Matadepera</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg,#667eea,#764ba2);
      min-height:100vh;
      padding:16px;
    }

    .container {
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.2);
      overflow:hidden;
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 24px;
      background:linear-gradient(135deg,#667eea,#764ba2);
      color:#fff;
    }

    header h1 { font-size:1.4rem; }

    .user-info {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:0.9rem;
    }

    button {
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:0.9rem;
      cursor:pointer;
      transition:transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    button.primary {
      background:#fff;
      color:#4f46e5;
      font-weight:600;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }

    button.secondary {
      background:rgba(255,255,255,0.12);
      color:#fff;
      border:1px solid rgba(255,255,255,0.35);
    }

    button:hover { transform:translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,0.18); }

    main { padding:16px 24px 24px; }

    .tabs {
      display:flex;
      gap:8px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .tab-btn {
      background:#eef2ff;
      color:#4f46e5;
      padding:8px 14px;
      border-radius:999px;
      cursor:pointer;
      border:1px solid transparent;
      font-size:0.9rem;
    }
    .tab-btn.active {
      background:#4f46e5;
      color:#fff;
      border-color:#4338ca;
    }

    .tab {
      display:none;
      animation:fadeIn .2s ease;
    }
    .tab.active { display:block; }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(4px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .grid {
      display:grid;
      grid-template-columns:1.5fr 1fr;
      gap:20px;
    }
    @media (max-width:900px){
      .grid { grid-template-columns:1fr; }
    }

    .card {
      background:#f9fafb;
      border-radius:12px;
      padding:14px 16px;
      border:1px solid #e5e7eb;
    }

    .card h2 {
      font-size:1rem;
      margin-bottom:8px;
      color:#111827;
    }

    .small {
      font-size:0.85rem;
      color:#6b7280;
    }

    .slider-row {
      display:flex;
      align-items:center;
      gap:12px;
      margin:8px 0;
    }
    .slider-row label {
      flex:0 0 140px;
      font-size:0.9rem;
    }
    .slider-row input[type="range"] {
      flex:1;
    }
    .slider-value {
      width:40px;
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-size:0.9rem;
    }

    .category-tag {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.7rem;
      background:#e0e7ff;
      color:#4338ca;
      text-transform:uppercase;
      letter-spacing:.04em;
    }

    .proposal-list { display:flex; flex-direction:column; gap:10px; margin-top:8px; }

    .proposal-item {
      background:#fff;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid #e5e7eb;
    }

    .proposal-item h3 {
      font-size:0.95rem;
      margin-bottom:4px;
      color:#111827;
    }

    .proposal-item p { font-size:0.85rem; color:#4b5563; }

    .proposal-meta {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:0.75rem;
      color:#6b7280;
      gap:6px;
      flex-wrap:wrap;
    }

    .pill {
      border-radius:999px;
      padding:2px 8px;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .section-title {
      font-size:0.95rem;
      margin-bottom:4px;
      font-weight:600;
    }

    .error {
      color:#b91c1c;
      font-size:0.82rem;
      margin-top:4px;
    }

    .info {
      font-size:0.82rem;
      color:#374151;
      margin-top:6px;
    }

    dialog {
      border:none;
      border-radius:16px;
      padding:18px 20px;
      max-width:420px;
      width:100%;
      box-shadow:0 20px 50px rgba(0,0,0,0.3);
    }

    dialog::backdrop {
      background:rgba(0,0,0,0.45);
      backdrop-filter:blur(3px);
    }

    .modal-title {
      font-size:1rem;
      margin-bottom:8px;
    }

    .field {
      margin:8px 0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .field label { font-size:0.85rem; color:#374151; }
    .field input, .field textarea, .field select {
      border-radius:8px;
      border:1px solid #d1d5db;
      padding:6px 8px;
      font-size:0.9rem;
      width:100%;
    }

    textarea { min-height:80px; resize:vertical; }

    .modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }

    .badge {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#ecfeff;
      color:#0891b2;
      font-size:0.75rem;
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Participació Ciutadana · Matadepera</h1>
        <div class="small">Panell d'opinió i propostes veïnals</div>
      </div>
      <div class="user-info">
        <span id="userStatus">No has iniciat sessió</span>
        <button class="secondary" id="btnLogin">Inicia sessió</button>
      </div>
    </header>

    <main>
      <div class="tabs">
        <button class="tab-btn active" data-tab="overview">Panell general</button>
        <button class="tab-btn" data-tab="myvotes">Els meus vots</button>
        <button class="tab-btn" data-tab="proposals">Propostes ciutadanes</button>
      </div>

      <!-- TAB 1: Overview -->
      <section id="tab-overview" class="tab active">
        <div class="grid">
          <div class="card">
            <h2>Com valores el poble?</h2>
            <p class="small">Valora de 0 (molt malament) a 100 (excel·lent). Els teus vots són anònims.</p>

            <div id="sliderContainer"></div>

            <p class="info">
              Els valors mitjans de cada categoria es mostren a la dreta. Pots modificar el teu vot sempre que vulguis.
            </p>
            <div id="saveStatus" class="small"></div>
          </div>

          <div class="card">
            <h2>Mitjana de satisfacció</h2>
            <div id="averageList" class="small">
              Carregant mitjanes…
            </div>
          </div>
        </div>
      </section>

      <!-- TAB 2: My votes -->
      <section id="tab-myvotes" class="tab">
        <div class="card">
          <h2>Els meus vots i propostes relacionades</h2>
          <p class="small">
            Aquí veus els teus valors per categoria i les propostes que altres veïns han fet en cada àmbit.
          </p>
          <div id="myVotesContent" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- TAB 3: Proposals -->
      <section id="tab-proposals" class="tab">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
              <h2>Propostes ciutadanes</h2>
              <p class="small">Idees per millorar Matadepera. Ordenades per data (les més recents primer).</p>
            </div>
            <button class="primary" id="btnNewProposal">Nova proposta</button>
          </div>

          <div class="field" style="margin-top:10px; max-width:260px;">
            <label for="filterCategory">Filtra per categoria</label>
            <select id="filterCategory">
              <option value="">Totes les categories</option>
              <option value="mobilitat">Mobilitat</option>
              <option value="residus">Residus i neteja</option>
              <option value="espai_public">Espai públic</option>
              <option value="seguretat">Seguretat</option>
              <option value="activitats">Activitats i convivència</option>
            </select>
          </div>

          <div id="proposalList" class="proposal-list"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Login modal -->
  <dialog id="loginDialog">
    <form id="loginForm" method="dialog">
      <div class="modal-title">Inicia sessió</div>
      <p class="small">
        Introdueix el teu correu i la contrasenya que t’hagi proporcionat l’organització.
      </p>

      <div class="field">
        <label for="loginEmail">Correu electrònic</label>
        <input type="email" id="loginEmail" required />
      </div>
      <div class="field">
        <label for="loginPassword">Contrasenya</label>
        <input type="password" id="loginPassword" required />
      </div>

      <div id="loginError" class="error" style="display:none;"></div>

      <div class="modal-actions">
        <button type="button" onclick="loginDialog.close()">Cancel·la</button>
        <button type="submit" class="primary">Entra</button>
      </div>
    </form>
  </dialog>

  <!-- New proposal modal -->
  <dialog id="proposalDialog">
    <form id="proposalForm" method="dialog">
      <div class="modal-title">Nova proposta</div>
      <p class="small">
        Explica breument la teva idea. El teu nom no és públic; només es guarda el correu per evitar abusos.
      </p>

      <div class="field">
        <label for="proposalTitle">Títol</label>
        <input type="text" id="proposalTitle" required />
      </div>

      <div class="field">
        <label for="proposalCategory">Categoria</label>
        <select id="proposalCategory" required>
          <option value="">— tria una categoria —</option>
          <option value="mobilitat">Mobilitat</option>
          <option value="residus">Residus i neteja</option>
          <option value="espai_public">Espai públic</option>
          <option value="seguretat">Seguretat</option>
          <option value="activitats">Activitats i convivència</option>
        </select>
      </div>

      <div class="field">
        <label for="proposalDescription">Descripció</label>
        <textarea id="proposalDescription" required></textarea>
      </div>

      <div id="proposalError" class="error" style="display:none;"></div>

      <div class="modal-actions">
        <button type="button" onclick="proposalDialog.close()">Cancel·la</button>
        <button type="submit" class="primary">Envia</button>
      </div>
    </form>
  </dialog>

  <script>
    // === CONFIG ===
    const SATISFACTION_URL = "/.netlify/functions/satisfaction";
    const PROPOSALS_URL    = "/.netlify/functions/proposals";
    const AUTH_URL         = "/.netlify/functions/auth";

    const CATEGORIES = [
      { id: "mobilitat",     label: "Mobilitat i trànsit" },
      { id: "residus",       label: "Residus i neteja" },
      { id: "espai_public",  label: "Espai públic i zones verdes" },
      { id: "seguretat",     label: "Seguretat ciutadana" },
      { id: "activitats",    label: "Activitats, cultura i convivència" }
    ];

    let currentEmail = null;
    let userRatings = {};
    let averages = {};
    let allProposals = [];

    // === TABS ===
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById("tab-" + btn.dataset.tab).classList.add("active");

        if (btn.dataset.tab === "myvotes") {
          renderMyVotes();
        }
      });
    });

    // === LOGIN HANDLING ===
    const loginDialog = document.getElementById("loginDialog");
    const proposalDialog = document.getElementById("proposalDialog");
    const loginErrorEl = document.getElementById("loginError");
    const userStatusEl = document.getElementById("userStatus");
    const btnLogin = document.getElementById("btnLogin");

    function setLoggedIn(email) {
      currentEmail = email;
      localStorage.setItem("pc_userEmail", email);
      userStatusEl.textContent = "Sessió iniciada: " + email;
      btnLogin.textContent = "Canvia usuari";
    }

    function setLoggedOut() {
      currentEmail = null;
      localStorage.removeItem("pc_userEmail");
      userStatusEl.textContent = "No has iniciat sessió";
      btnLogin.textContent = "Inicia sessió";
    }

    btnLogin.addEventListener("click", () => {
      loginErrorEl.style.display = "none";
      if (currentEmail) {
        // „Abmelden / anderes Konto“
        setLoggedOut();
        userRatings = {};
        renderSliders();
        renderMyVotes();
      } else {
        // Login starten
        const saved = localStorage.getItem("pc_userEmail");
        if (saved) document.getElementById("loginEmail").value = saved;
        document.getElementById("loginPassword").value = "";
        loginDialog.showModal();
      }
    });

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      loginErrorEl.style.display = "none";

      const email = document.getElementById("loginEmail").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) return;

      try {
        const res = await fetch(AUTH_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          loginErrorEl.textContent = data.error || "Contrasenya incorrecta o error en l'autenticació.";
          loginErrorEl.style.display = "block";
          return;
        }

        setLoggedIn(email);
        loginDialog.close();

        // nach erfolgreichem Login: eigene Bewertungen laden
        await loadUserRatings();
        renderSliders();
        renderMyVotes();

      } catch (err) {
        console.error("Auth error", err);
        loginErrorEl.textContent = "Error de connexió amb el servidor.";
        loginErrorEl.style.display = "block";
      }
    });

    // === SLIDERS (Overview) ===
    const sliderContainer = document.getElementById("sliderContainer");
    const saveStatusEl = document.getElementById("saveStatus");
    const averageListEl = document.getElementById("averageList");

    function renderSliders() {
      sliderContainer.innerHTML = "";
      CATEGORIES.forEach(cat => {
        const row = document.createElement("div");
        row.className = "slider-row";

        const label = document.createElement("label");
        label.textContent = cat.label;

        const input = document.createElement("input");
        input.type = "range";
        input.min = "0";
        input.max = "100";
        input.step = "1";

        const currentValue = userRatings[cat.id];
        input.value = typeof currentValue === "number" ? currentValue : 50;

        const valueSpan = document.createElement("span");
        valueSpan.className = "slider-value";
        valueSpan.textContent = input.value;

        input.addEventListener("input", () => {
          valueSpan.textContent = input.value;
        });

        input.addEventListener("change", () => {
          if (!currentEmail) {
            alert("Per guardar el teu vot has d'iniciar sessió.");
            valueSpan.textContent = input.value;
            return;
          }
          saveRating(cat.id, Number(input.value));
        });

        row.appendChild(label);
        row.appendChild(input);
        row.appendChild(valueSpan);
        sliderContainer.appendChild(row);
      });
    }

    async function saveRating(category, value) {
      saveStatusEl.textContent = "Desant…";
      try {
        const res = await fetch(SATISFACTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "saveRating",
            email: currentEmail,
            category,
            value
          })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Error en desar el vot");

        userRatings[category] = data.rating?.value ?? value;
        saveStatusEl.textContent = "Vot desat correctament.";
        setTimeout(() => saveStatusEl.textContent = "", 2000);

        await loadAverages();
        renderAverages();
        renderMyVotes();

      } catch (err) {
        console.error(err);
        saveStatusEl.textContent = "No s'ha pogut desar. Torna-ho a provar més tard.";
      }
    }

    function renderAverages() {
      if (!averages || Object.keys(averages).length === 0) {
        averageListEl.textContent = "Encara no hi ha prou dades.";
        return;
      }
      const ul = document.createElement("ul");
      ul.style.listStyle = "none";
      ul.style.padding = 0;

      CATEGORIES.forEach(cat => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.margin = "4px 0";
        const a = averages[cat.id];
        li.innerHTML = `
          <span>${cat.label}</span>
          <span><strong>${a != null ? a.toFixed(1) : "—"}</strong> / 100</span>
        `;
        ul.appendChild(li);
      });

      averageListEl.innerHTML = "";
      averageListEl.appendChild(ul);
    }

    // === "Els meus vots" ===
    const myVotesContent = document.getElementById("myVotesContent");

    function renderMyVotes() {
      myVotesContent.innerHTML = "";

      if (!currentEmail) {
        myVotesContent.innerHTML = `
          <p class="small">
            Per veure els teus vots has d'<strong>iniciar sessió</strong>.
          </p>`;
        return;
      }

      if (!CATEGORIES.length) return;

      CATEGORIES.forEach(cat => {
        const section = document.createElement("div");
        section.className = "card";
        section.style.marginBottom = "8px";

        const userVal = userRatings[cat.id];
        const avgVal  = averages[cat.id];

        section.innerHTML = `
          <div class="section-title">${cat.label}</div>
          <div class="small">
            El teu vot: <strong>${userVal != null ? userVal + " / 100" : "encara no has votat"}</strong>
            &nbsp;&nbsp;|&nbsp;&nbsp;
            Mitjana global: <strong>${avgVal != null ? avgVal.toFixed(1) + " / 100" : "—"}</strong>
          </div>
        `;

        const list = document.createElement("div");
        list.className = "proposal-list";
        const related = allProposals.filter(p => p.category === cat.id);

        if (related.length === 0) {
          const empty = document.createElement("p");
          empty.className = "small";
          empty.style.marginTop = "6px";
          empty.textContent = "Encara no hi ha propostes en aquesta categoria.";
          list.appendChild(empty);
        } else {
          related.forEach(p => {
            const item = document.createElement("div");
            item.className = "proposal-item";
            item.innerHTML = `
              <div class="category-tag">${cat.label}</div>
              <h3>${p.title}</h3>
              <p>${p.description || ""}</p>
              <div class="proposal-meta">
                <span class="pill">${p.email || "veí anònim"}</span>
                <span>${new Date(p.created_at).toLocaleString("ca-ES")}</span>
              </div>
            `;
            list.appendChild(item);
          });
        }

        section.appendChild(list);
        myVotesContent.appendChild(section);
      });
    }

    // === PROPOSALS TAB ===
    const proposalListEl = document.getElementById("proposalList");
    const filterCategory = document.getElementById("filterCategory");
    const proposalErrorEl = document.getElementById("proposalError");

    filterCategory.addEventListener("change", () => renderProposalList());

    function renderProposalList() {
      proposalListEl.innerHTML = "";
      if (!allProposals.length) {
        proposalListEl.innerHTML = `<p class="small">Encara no hi ha propostes.</p>`;
        return;
      }

      const selected = filterCategory.value;
      const list = selected
        ? allProposals.filter(p => p.category === selected)
        : allProposals;

      if (!list.length) {
        proposalListEl.innerHTML = `<p class="small">No hi ha propostes en aquesta categoria.</p>`;
        return;
      }

      list.forEach(p => {
        const cat = CATEGORIES.find(c => c.id === p.category);
        const item = document.createElement("div");
        item.className = "proposal-item";
        item.innerHTML = `
          <div class="category-tag">${cat ? cat.label : p.category}</div>
          <h3>${p.title}</h3>
          <p>${p.description || ""}</p>
          <div class="proposal-meta">
            <span class="pill">${p.email || "veí anònim"}</span>
            <span>${new Date(p.created_at).toLocaleString("ca-ES")}</span>
          </div>
        `;
        proposalListEl.appendChild(item);
      });
    }

    document.getElementById("btnNewProposal").addEventListener("click", () => {
      if (!currentEmail) {
        alert("Has d'iniciar sessió per enviar una proposta.");
        return;
      }
      proposalErrorEl.style.display = "none";
      document.getElementById("proposalForm").reset();
      proposalDialog.showModal();
    });

    document.getElementById("proposalForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      proposalErrorEl.style.display = "none";

      if (!currentEmail) {
        proposalErrorEl.textContent = "Has d'iniciar sessió.";
        proposalErrorEl.style.display = "block";
        return;
      }

      const title = document.getElementById("proposalTitle").value.trim();
      const category = document.getElementById("proposalCategory").value;
      const description = document.getElementById("proposalDescription").value.trim();

      if (!title || !category || !description) {
        proposalErrorEl.textContent = "Tots els camps són obligatoris.";
        proposalErrorEl.style.display = "block";
        return;
      }

      try {
        const res = await fetch(PROPOSALS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title,
            category,
            description,
            email: currentEmail,
            author: currentEmail
          })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Error en desar la proposta");

        allProposals.unshift(data); // neueste zuerst
        renderProposalList();
        renderMyVotes();
        proposalDialog.close();

      } catch (err) {
        console.error(err);
        proposalErrorEl.textContent = err.message || "No s'ha pogut desar la proposta.";
        proposalErrorEl.style.display = "block";
      }
    });

    // === API CALLS ===
    async function loadAverages() {
      try {
        const res = await fetch(SATISFACTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "getAverages" })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Error");
        averages = data.averages || {};
      } catch (err) {
        console.error("Error loading averages", err);
        averages = {};
      }
    }

    async function loadUserRatings() {
      if (!currentEmail) {
        userRatings = {};
        return;
      }
      try {
        const res = await fetch(SATISFACTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "getUserRatings",
            email: currentEmail
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Error");
        userRatings = data.ratings || {};
      } catch (err) {
        console.error("Error loading user ratings", err);
        userRatings = {};
      }
    }

    async function loadProposals() {
      try {
        const res = await fetch(PROPOSALS_URL);
        const data = await res.json().catch(() => []);
        if (!res.ok) throw new Error(data.error || "Error");
        allProposals = Array.isArray(data) ? data : [];
      } catch (err) {
        console.error("Error loading proposals", err);
        allProposals = [];
      }
    }

    // === INIT ===
    (async function init() {
      // gespeicherte E-Mail laden
      const saved = localStorage.getItem("pc_userEmail");
      if (saved) setLoggedIn(saved);

      renderSliders();
      await Promise.all([
        loadAverages(),
        loadUserRatings(),
        loadProposals()
      ]);
      renderAverages();
      renderSliders();
      renderProposalList();
      renderMyVotes();
    })();
  </script>
</body>
</html>
