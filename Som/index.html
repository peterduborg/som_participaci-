import { neon } from '@neondatabase/serverless';

const sql = neon(process.env.NEON_DATABASE_URL);

/*
Erwartete Tabellen (Beispiel):

CREATE TABLE proposals (
  id          text PRIMARY KEY,
  title       text NOT NULL,
  category    text NOT NULL,
  description text NOT NULL,
  author      text NOT NULL,
  email       text NOT NULL,
  created_at  timestamptz NOT NULL
);

CREATE TABLE votes (
  user_email  text NOT NULL,
  proposal_id text NOT NULL,
  value       integer NOT NULL,
  updated_at  timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY (user_email, proposal_id)
);

CREATE TABLE comments (
  id           uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  proposal_id  text NOT NULL,
  user_email   text NOT NULL,
  comment_text text NOT NULL,
  created_at   timestamptz NOT NULL DEFAULT now()
);
*/

export async function handler(event) {
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method not allowed' })
    };
  }

  let body;
  try {
    body = JSON.parse(event.body || '{}');
  } catch (e) {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'Invalid JSON' })
    };
  }

  const { action } = body;
  if (!action) {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'Missing action' })
    };
  }

  try {
    if (action === 'saveProposals') {
      const { email, proposals } = body;
      if (!email || !Array.isArray(proposals)) {
        return {
          statusCode: 400,
          body: JSON.stringify({ error: 'Missing email or proposals' })
        };
      }

      // Upsert fÃ¼r jede Proposal
      await Promise.all(
        proposals.map(p =>
          sql`
            INSERT INTO proposals (id, title, category, description, author, email, created_at)
            VALUES (
              ${p.id},
              ${p.title},
              ${p.category},
              ${p.desc},
              ${p.author},
              ${p.email},
              ${p.createdAt}
            )
            ON CONFLICT (id) DO UPDATE SET
              title       = EXCLUDED.title,
              category    = EXCLUDED.category,
              description = EXCLUDED.description,
              author      = EXCLUDED.author,
              email       = EXCLUDED.email,
              created_at  = EXCLUDED.created_at
          `
        )
      );

      return {
        statusCode: 200,
        body: JSON.stringify({ ok: true })
      };
    }

    if (action === 'saveVotes') {
      const { email, votes } = body;
      if (!email || !votes || typeof votes !== 'object') {
        return {
          statusCode: 400,
          body: JSON.stringify({ error: 'Missing email or votes' })
        };
      }

      const entries = Object.entries(votes);
      if (entries.length === 0) {
        return {
          statusCode: 200,
          body: JSON.stringify({ ok: true, message: 'No votes to save' })
        };
      }

      await Promise.all(
        entries.map(([proposalId, value]) =>
          sql`
            INSERT INTO votes (user_email, proposal_id, value)
            VALUES (${email}, ${proposalId}, ${value})
            ON CONFLICT (user_email, proposal_id)
            DO UPDATE SET
              value      = EXCLUDED.value,
              updated_at = now()
          `
        )
      );

      return {
        statusCode: 200,
        body: JSON.stringify({ ok: true })
      };
    }

    if (action === 'addComment') {
      const { email, proposalId, comment } = body;
      if (!email || !proposalId || !comment) {
        return {
          statusCode: 400,
          body: JSON.stringify({ error: 'Missing email, proposalId or comment' })
        };
      }

      const rows = await sql`
        INSERT INTO comments (proposal_id, user_email, comment_text)
        VALUES (${proposalId}, ${email}, ${comment})
        RETURNING id, proposal_id, user_email, comment_text, created_at
      `;

      return {
        statusCode: 200,
        body: JSON.stringify({ ok: true, comment: rows[0] })
      };
    }

    // Unbekannte Action
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'Unknown action: ' + action })
    };

  } catch (err) {
    console.error('participacio error', err);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Server error', details: String(err) })
    };
  }
}
